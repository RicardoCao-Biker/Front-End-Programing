### 什么是CSRF攻击（跨站请求伪造 ），如何预防\(\*\)

![](https://images0.cnblogs.com/blog2015/605407/201505/251556473348010.jpg)

#### 过程

1. 用户打开浏览器，访问受信任网站A，输入用户名和密码请求登录网站A；

2. 在用户信息通过验证后，网站A产生Cookie信息并返回给浏览器，此时用户登录网站A成功，可以正常发送请求到网站A；

3. 用户未退出网站A之前，在同一浏览器中，打开一个TAB页访问网站B；

4. 网站B接收到用户请求后，返回一些攻击性代码，并发出一个请求要求访问第三方站点A；

5. 浏览器在接收到这些攻击性代码后，根据网站B的请求，在用户不知情的情况下携带Cookie信息，向网站A发出请求。网站A并不知道该请求其实是由B发起的，所以会根据用户的Cookie信息以的权限处理该请求，导致来自网站B的恶意代码被执行。

#### 避免：

1. 验证 HTTP Referer 字段 : 在 HTTP 头中有一个字段叫 Referer，它记录了该 HTTP 请求的来源地址。在通常情况下，访问一个安全受限页面的请求来自于同一个网站。

2. CSRF Tokens

   最终的解决办法是使用CSRF tokens。在请求地址中添加 token 并验证 ，CSRF tokens是如何工作的呢？

   > 在后端生成表单的时候生成一串随机 token ，内置到表单里成为一个字段，同时，将此串 token 置入 session 中。每次表单提交到后端时都会检查这两个值是否一致，以此来判断此次表单提交是否是可信的。

   攻击者需要通过某种手段获取你站点的CSRF token， 他们只能使用JavaScript来做。 所以，如果你的站点不支持CORS， 那么他们就没有办法来获取CSRF token， 降低了威胁。

   **确保CSRF token不能通过AJAX访问到!**不要创建一个`/CSRF`路由来获取一个token， 尤其不要在这个路由上支持CORS!

  



